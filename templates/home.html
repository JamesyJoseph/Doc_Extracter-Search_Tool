<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF Data Extractor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

</head>
<body class="bg-light">
    <div class="container py-5">

        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}

        <h1 class="mb-4 text-center">PDF Data Extract & Search</h1>

        <div class="card mb-4">
            <div class="card-header">Upload PDF Files</div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" name="pdfs" accept="application/pdf" multiple required class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>

         

        {% if preview %}
        <div id="preview-container">
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark fw-bold">
                    {{ preview.filename }}
                </div>
                <form id="preview-form" action="/update_preview" method="post" onsubmit="return updatePreview(event)">
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for unit in preview.units %}
                            {% set unit_index = loop.index0 %}
                            <div class="card mb-3 border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    Unit {{ loop.index }}
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-bordered table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 30%;">Field</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for key, value in unit.items() %}
                                                <tr>
                                                    <td><label for="unit-{{ unit_index }}-{{ key }}">{{ key }}</label></td>
                                                    <td>
                                                        <input type="text"
                                                            class="form-control"
                                                            id="unit-{{ unit_index }}-{{ key }}"
                                                            name="units[{{ unit_index }}][{{ key }}]"
                                                            value="{{ value }}">
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                    </div>


                    <hr>
                    <h5>Add New Unit</h5>
                    <div id="unit-fields" class="mb-3"></div>

                    <button type="button" class="btn btn-secondary mb-2" onclick="addUnitField()">Add Field</button>

                    <input type="hidden" name="new_unit_fields" id="new_unit_fields_json">
                    <button type="submit" class="btn btn-primary">Insert / Update Units</button>
                </form>


                <form action="/push_to_original" method="post" class="mt-3">
                    <button type="submit" class="btn btn-success ms-2" style="float:right"><i class="bi bi-plus"></i></button>
                </form>
                
            </div>
        </div>
        {% else %}
            <p>No structured unit details found in this file.</p>
        {% endif %}


        <br><br>


        <div class="card mb-4">
            <div class="card-header">Search in PDFs</div>
            <div class="card-body">
                <form action="/search" method="get" class="row g-3">
                    <div class="col-md-5">
                        <input type="text" name="q" class="form-control" placeholder="Search by keyword...">
                    </div>


                    <div class="col-md-5">
                        <select name="filename" class="form-control">
                            <option value="" disabled selected> Search by File </option>
                            {% for fname in filenames %}
                                <option value="{{ fname }}" {% if fname == filename %}selected{% endif %}>{{ fname }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100">Search</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="text-center">
            <form action="/clear" method="post" onsubmit="return confirm('Are you sure you want to clear all data?');">
                <button type="submit" class="btn btn-danger"> Clear All Datas</button>
            </form>
        </div>
    </div>

</body>

<script>
function updatePreview(event) {
    event.preventDefault(); // Prevent full page refresh

    const form = document.getElementById('preview-form');
    const formData = new FormData(form);
    console.log("Data",form);

    fetch('/update_preview', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('preview-container').innerHTML = html;
    })
    .catch(error => {
        console.error('Error updating preview:', error);
    });

    return false;
}

let newUnit = {};

    function addUnitField() {
        const container = document.getElementById("unit-fields");
        const index = Object.keys(newUnit).length;

        const div = document.createElement("div");
        div.className = "row mb-2";
        div.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Field name" onchange="updateNewUnit(${index}, this.value, 'key')">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Value" onchange="updateNewUnit(${index}, this.value, 'value')">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger" onclick="removeField(this)">X</button>
            </div>
        `;
        container.appendChild(div);

        newUnit[index] = { key: '', value: '' };
    }

    function updateNewUnit(index, val, type) {
        if (!newUnit[index]) newUnit[index] = { key: '', value: '' };
        newUnit[index][type] = val;

        // Build clean object
        const cleaned = {};
        for (const entry of Object.values(newUnit)) {
            if (entry.key && entry.value) {
                cleaned[entry.key] = entry.value;
            }
        }

        document.getElementById("new_unit_fields_json").value = JSON.stringify(cleaned);
    }

    function removeField(btn) {
        const div = btn.parentElement.parentElement;
        div.remove();
        // Clean state if needed
    }

    function updatePreview(event) {
        // Optional: Confirm or validate before submission
        return true;
    }

</script>

</html>